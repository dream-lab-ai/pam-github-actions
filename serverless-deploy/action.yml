name: 'Serverless Deploy'
description: 'Deploy serverless applications with automatic URL extraction and validation'
author: 'Pam Team'

inputs:
  stage:
    description: 'Deployment stage (dev, prod, etc.)'
    required: true
  service-name:
    description: 'Service name for stack identification'
    required: false
  wait-time:
    description: 'Seconds to wait after deployment'
    required: false
    default: '30'
  extract-url:
    description: 'Whether to extract API URL from deployment'
    required: false
    default: 'true'
  url-output-key:
    description: 'Output key name to extract URL from (ServiceEndpoint or HttpApiUrl)'
    required: false
    default: 'ServiceEndpoint'
  verbose:
    description: 'Enable verbose output'
    required: false
    default: 'false'

outputs:
  api_url:
    description: 'Extracted API Gateway URL'
    value: ${{ steps.extract_url.outputs.api_url }}
  deployment_time:
    description: 'ISO timestamp of deployment'
    value: ${{ steps.set_time.outputs.time }}
  deployment_successful:
    description: 'Boolean indicating if deployment succeeded'
    value: ${{ steps.deploy.outputs.deployment_successful }}

runs:
  using: 'composite'
  steps:
    - name: Set Deployment Time
      id: set_time
      shell: bash
      run: echo "time=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

    - name: Deploy Serverless Application
      id: deploy
      shell: bash
      run: |
        echo "## Serverless Deployment" >> $GITHUB_STEP_SUMMARY
        echo "ðŸš€ Starting deployment to **${{ inputs.stage }}**..." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Prepare deployment command
        deploy_cmd="npx sls deploy --stage ${{ inputs.stage }}"
        if [ "${{ inputs.verbose }}" = "true" ]; then
          deploy_cmd="$deploy_cmd --verbose"
        fi

        # Run deployment and capture output
        echo "Running: $deploy_cmd"
        set +e  # Don't exit on error immediately
        $deploy_cmd | tee deployment_output.txt
        deploy_exit_code=${PIPESTATUS[0]}
        set -e  # Re-enable exit on error

        if [ $deploy_exit_code -eq 0 ]; then
          echo "deployment_successful=true" >> $GITHUB_OUTPUT
          echo "âœ… Deployment completed successfully" >> $GITHUB_STEP_SUMMARY
        else
          echo "deployment_successful=false" >> $GITHUB_OUTPUT
          echo "âŒ Deployment failed with exit code $deploy_exit_code" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Output" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat deployment_output.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi

    - name: Extract API URL
      id: extract_url
      if: inputs.extract-url == 'true' && steps.deploy.outputs.deployment_successful == 'true'
      shell: bash
      run: |
        echo "ðŸ” Extracting API URL..."
        api_url=""

        # Method 1: Extract from deployment output
        api_url=$(grep "${{ inputs.url-output-key }}:" deployment_output.txt | awk '{print $2}' | head -1 || echo "")

        # Method 2: Try sls info command
        if [ -z "$api_url" ] || [ "$api_url" = "null" ]; then
          echo "Trying sls info command..."
          npx sls info --stage ${{ inputs.stage }} --verbose | tee info_output.txt
          api_url=$(grep "${{ inputs.url-output-key }}:" info_output.txt | awk '{print $2}' | head -1 || echo "")
        fi

        # Method 3: Try AWS CLI
        if [ -z "$api_url" ] || [ "$api_url" = "null" ]; then
          echo "Trying AWS CLI..."
          if [ -n "${{ inputs.service-name }}" ]; then
            stack_name="${{ inputs.service-name }}-${{ inputs.stage }}"
          else
            # Try to detect from serverless.yml
            stack_name=$(grep "service:" serverless.yml | awk '{print $2}' | head -1 || echo "")
            if [ -n "$stack_name" ]; then
              stack_name="${stack_name}-${{ inputs.stage }}"
            fi
          fi
          
          if [ -n "$stack_name" ]; then
            api_url=$(aws cloudformation describe-stacks --stack-name "$stack_name" \
              --query "Stacks[0].Outputs[?OutputKey==\`${{ inputs.url-output-key }}\`].OutputValue" \
              --output text 2>/dev/null || echo "")
          fi
        fi

        # Validate URL extraction
        if [ -z "$api_url" ] || [ "$api_url" = "null" ]; then
          echo "âš ï¸ Warning: Could not extract API URL" >> $GITHUB_STEP_SUMMARY
          echo "api_url=" >> $GITHUB_OUTPUT
        else
          echo "api_url=$api_url" >> $GITHUB_OUTPUT
          echo "- **API URL:** $api_url" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Wait for Deployment
      if: steps.deploy.outputs.deployment_successful == 'true'
      shell: bash
      run: |
        wait_time="${{ inputs.wait-time }}"
        if [ "$wait_time" -gt 0 ]; then
          echo "â³ Waiting ${wait_time}s for deployment to stabilize..."
          sleep "$wait_time"
        fi

    - name: Deployment Summary
      if: always()
      shell: bash
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Deployment Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Stage:** ${{ inputs.stage }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Time:** ${{ steps.set_time.outputs.time }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Status:** ${{ steps.deploy.outputs.deployment_successful == 'true' && 'âœ… Success' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
